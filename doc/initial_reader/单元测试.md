# 单元测试

[单元测试准则](https://github.com/yangyubo/zh-unit-testing-guidelines)

- TDD（测试驱动开发）
- BDD（行为驱动开发）

区别：

    // TDD
    suite('Array', function() {
      setup(function() {
      });
     
      test('equal -1 when index beyond array length', function() {
        assert.equal(-1, [1,2,3].indexOf(4));
      });
    });
     
    // BDD
    describe('Array', function() {
      before(function() {
      });
     
      it('should return -1 when no such index', function() {
        [1,2,3].indexOf(4).should.equal(-1);
      });
    });

## mocha

    $npm install -g mocha
 
1. mocha（Mocha is a feature-rich JavaScript test framework running on node.js and the browser, making asynchronous testing simple and fun.）
1. chai（Chai is a BDD / TDD assertion library for node and the browser that can be delightfully paired with any javascript testing framework.）
1. sinon（Standalone test spies, stubs and mocks for JavaScript.）
1. zombie (页面事件模拟Zombie.js is a lightweight framework for testing client-side JavaScript code in a simulated environment. No browser required.)
1. supertest(接口测试 Super-agent driven library for testing node.js HTTP servers using a fluent API)

辅助工具：

- 断言库：
    - [should.js](https://github.com/tj/should.js)：should 是一个表述性、可读性很强的测试无关的“断言”库。它是BDD风格的，用一个单例的不可枚举的属性访问器扩展了Object的prototype，允许你表述对象应该展示的行为。
    - Chai
    - expect.js
    - assert.js
- Web测试
    - supertest：supertest 是一个非常棒的适用于node的模拟HTTP请求的库
- cucumber（敏捷）
    - https://github.com/cucumber/cucumber-js
- vowsjs （敏捷）
    - http://vowsjs.org/
- 测试私有方法
    - rewire    
- Mock库
    - muk
- 模拟用户数据
    - faker

### 异步操作的测试

    describe('User', function() {
        describe('#save()', function() {
            it('should save without error', function(done) {
                var user = new User('Luna');
                user.save(done);
            });
        });
    });
    
### 具备正反测试用例

    describe('sign up', function() {
      it('should not sign up an user when loginname is empty', function(done) {
        request.post('/signup')
        .send({
          loginname: '',
          password: password
        })
        .expect(200, function(err, res) {
          should.not.exist(err);
          res.text.should.containEql('用户名或密码不能为空');
          done();
        });
      });
      it('should not sign up an user when it is exist', function(done) {
        request.post('/signup')
        .send({
          loginname: loginname,
          password: password
        })
        .expect(200, function(err, res) {
          should.not.exist(err);
          res.text.should.containEql('用户已经存在');
          done();
        });
      });
    });
    
### 需要cookie和session的测试案例

    set('Cookie', cookieValue)
    
    app.use(function(req, res, next) {
      if (config.debug && req.cookies['mock_user']) {
        var mockUser = JSON.parse(req.cookies['mock_user']);
            req.session.user = new UserModel(mockUser);
            return next();
      }
      next();
    });
    
 
### 其他解决方案

- tape
    - https://github.com/substack/tape
    - https://en.wikipedia.org/wiki/Test_Anything_Protocol
- tap
    - https://github.com/isaacs/node-tap
- Jasmine
- qunit
- sinon
   
## 测试覆盖率 && 测试报告

[代码覆盖率 code coverage](https://en.wikipedia.org/wiki/Code_coverage)

1. 行覆盖率（line coverage）：是否每一行都执行
1. 函数覆盖率（function coverage）：是否每个函数都调用
1. 分支覆盖率（branch coverage）：是否每个if代码块都执行
1. 语句覆盖率（statement coverage）：是否每个语句都执行

### [coveralls](https://coveralls.io/)

创建 `.coveralls.yml`

并在 Makefile 添加（示例）：

    TESTS = test/*.js
    REPORTER = spec
    TIMEOUT = 20000
    ISTANBUL = ./node_modules/.bin/istanbul
    MOCHA = ./node_modules/mocha/bin/_mocha
    COVERALLS = ./node_modules/coveralls/bin/coveralls.js
    
    test:
    	@NODE_ENV=test $(MOCHA) -R $(REPORTER) -t $(TIMEOUT) \
    		$(MOCHA_OPTS) \
    		$(TESTS)
    
    test-cov:
    	@$(ISTANBUL) cover --report html $(MOCHA) -- -t $(TIMEOUT) -R spec $(TESTS)
    
    test-coveralls:
    	@$(ISTANBUL) cover --report lcovonly $(MOCHA) -- -t $(TIMEOUT) -R spec $(TESTS)
    	@echo TRAVIS_JOB_ID $(TRAVIS_JOB_ID)
    	@cat ./coverage/lcov.info | $(COVERALLS) && rm -rf ./coverage
    
    test-all: test test-coveralls
    
    .PHONY: test

或者

    TESTS = test/*.test.js
    REPORTER = spec
    TIMEOUT = 10000
    JSCOVERAGE = ./node_modules/jscover/bin/jscover
    
    test:
        @NODE_ENV=test ./node_modules/mocha/bin/mocha -R $(REPORTER) -t $(TIMEOUT) $(TESTS)
    
    test-cov: lib-cov
        @LIB_COV=1 $(MAKE) test REPORTER=dot
        @LIB_COV=1 $(MAKE) test REPORTER=html-cov > coverage.html
    
    lib-cov:
        @rm -rf ./lib-cov
        @$(JSCOVERAGE) lib lib-cov
    
    .PHONY: test test-cov lib-cov
    
    make test
    make test-cov
    
都是用以参考

### [istanbul](https://github.com/gotwarlost/istanbul)

可以通过3种途径生成覆盖报告

- cli
- 代码
- gulp 插件

安装：

    $ npm install -g istanbul

执行：

    $ istanbul cover my-test-script.js -- my test args

会生成./coverage目录，这里面就是测试报告

### 示例 package.json 配置：

    "scripts": {
      "start": "npm publish .",
      "test": "./node_modules/.bin/gulp",
      "mocha": "./node_modules/.bin/mocha -u bdd",
      "cov":"./node_modules/.bin/istanbul cover ./node_modules/mocha/bin/_mocha --report lcovonly -- -R spec && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage"
    }

执行：

    npm run mocha
    npm run cov

### 其他解决方案：

- jscover
- blanket

## Continuous integration 持续集成（CI）

持续集成是一种软件开发实践，即团队开发成员经常集成他们的工作，通常每个成员每天至少集成一次，也就意味着每天可能会发生多次集成。每次集成都通过自动化的构建（包括编译，发布，自动化测试)来验证，从而尽快地发现集成错误。许多团队发现这个过程可以大大减少集成的问题，让团队能够更快的开发内聚的软件。
也就是说，测试不通过不能部署，只有提交到服务器上，就可以自动跑测试，测试通过后，就可以部署到服务器上。
### 软件

- jenkins（自搭建）
    - https://jenkins.io/index.html
- travis（开源）
    - https://travis-ci.org/

## [oneapm](http://www.oneapm.com/) 性能监控

### Agent

1.2.8 以下的版本，请在应用程序的根目录下运行以下指令：

    npm install oneapm --registry http://npm.oneapm.com
    
1.2.8 及以上的版本，请在应用程序的根目录下运行以下指令：

    npm install oneapm
    
等待安装成功

###  配置

将 node_modules/oneapm 中的 oneapm.js 文件复制到应用程序的根目录下
修改配置文件 oneapm.js，设置 app_name，将 license_key 替换为 OneAPM 提供的license_key
复制以下代码至应用程序主模块文件第一行

    require('oneapm');

## API响应时间监测

- Grafana
    - Gra 用作数据呈现，封面截图就来自Gra。
- Telegraf
    - Telegraf 是安装于生产机的守护进程，用于埋点数据收集并转发到Gra数据库，并收集宿主机负载信息。
- InfluxDB
    - Inf是 time-series data 类型的数据库，支持类sql语句查询，适合监控数据存储，实时分析。

## 参考

https://github.com/JacksonTian/unittesting
http://html5ify.com/unittesting/slides/index.html
http://www.ruanyifeng.com/blog/2015/06/istanbul.html
http://coolshell.cn/articles/8209.html
http://stackoverflow.com/questions/153234/how-deep-are-your-unit-tests
https://github.com/yangyubo/zh-unit-testing-guidelines
http://www.codedata.com.tw/java/unit-test-the-way-changes-my-programming
http://wiki.ubuntu.org.cn/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile:MakeFile%E4%BB%8B%E7%BB%8D
https://github.com/yangyubo/zh-unit-testing-guidelines
https://github.com/visionmedia/superagent/blob/master/Makefile
http://www.open-open.com/lib/view/open1452168729620.html
http://www.oneapm.com/
http://grafana.org/
https://influxdata.com/
https://influxdata.com/time-series-platform/telegraf/
http://martinfowler.com/bliki/IntegrationContractTest.html 契约测试

## 工具集





### 在线 Web 页面性能评测工具

- [WebPagetest](http://www.webpagetest.org/)
- [Testcafe](http://testcafe.devexpress.com/)
    - Web 测试框架。它支持所有主流浏览器，操作系统和移动平台，支持远程设备，多浏览器并行测试。Testcafe 内置一个可视化测试记录器，支持持续集成，脚本标记分析等强大功能。
 - [Cuzillion](http://www.stevesouders.com/cuzillion/?ex=1&title=Inline+Scripts+Block+Rendering)
     - Cuzillion是一个很酷的工具，帮助你查看页面组件的交互，目标是帮助你在结构化页面的时候快速检查，测试和编辑web页面。
        
## 图形化请求测试工具

- [RESTClient](http://www.restclient.org/)
- [HttpRequester](https://sourceforge.net/projects/httprequester/)
- [HttpWatch](http://www.httpwatch.com/)
    - HTTP嗅探器，为IE和Firefox提供新的方法以查看您网站的负载和运行情况，可以监控请求头，响应头，显示资源加载瀑布图。
- [VB Watch](http://vb-watch.updatestar.com/)
    - VB Watch 是三种工具之一：Profiler, Protector 以及 Debugger. Profiler 衡量性能及测试覆盖率。 Protector 实现健壮的错误处理。 Debugger 有助于监控你的可执行文件。
- [Speed Tracer](http://www.speedtracer.com/)
    - Speed Tracer由Google开发的一款测试网页性能分析插件，而且开源。
    
- Performance Analyser
    - Performance Analyser可以自动分析网页性能，同时为你提供详细的性能指标。
- YSlow for Chrome
    - YSlow for Chrome是一款由Yahoo开发网站性能优化扩展，在十几个方面给你的网站提出优化建议，包括尽可能的减少 HTTP 的请求数 、使用 Gzip 压缩、将 CSS 样式放在页面的上方、将脚本移动到底部、减少 DNS 查询等十几条规则。
- Wireshark
    - Wireshark(前称Ethereal)是一个网络封包分析软件。网络封包分析软件的功能是撷取网络封包, 并尽可能显示出最为详细的网络封包资料。
- PageSpeed
    - Page Speed 是开源 Firefox/Firebug 插件，网站管理员和网络开发人员可以使用 Page Speed 来评估他们网页的性能，并获得有关如何改进性能的建议。
- dynaTrace Ajax Edition
    - dynaTrace Ajax Edition 是一个强大的底层追踪、前端性能分析工具。您可以利用它来分析页面渲染时间、DOM方法执行时间，甚至可以看到JS代码的解析时间。
- HTTP Archive
    - HTTP Archive可追踪网站的构建。HTTP Archive的代码开源，下载地址。
- PageSpeed Insights
    - PageSpeed Insights是谷歌推出的一款性能优化工具，其目的是帮助站长优化页面，从而能够带来最佳的渲染性能，尤其实针对移动页面。
- PhantomJS
    - PhantomJS是一款前端自动化测试工具。它本质上是一个基于webkit内核的无界面浏览器，并可使用JavaScript或CoffeeScript进行编程。
- Weinre
    - Weinre代表We b In spector Re mote，是一种远程调试工具。举个例子，在电脑上可以即时 的更改手机上对应网页的页面元素、样式表，或是查看Javascript变量，同时还可以看到手机上页面的错误和警告信息。
- Opera Dragonfly
    - Opera Dragonfly 是适用于 Opera 浏览器的跨设备、跨平台的调试环境 - 调试 JavaScript、检查和编辑 CSS 与 DOM,以及查看手机或计算机上的任何错误。
- Chrome for Android
    - Chrome for Android可在Android上远程调试Chrome浏览器。
- Apache Bench (ab)
    - ApacheBench 主要是用来测试阿帕奇服务器执行效率用的。
- Show Slow
    - Show Slow是一个开源的基于web的工具，用来收集从Page Speed获得的性能参数。
- Browserscope
    - Browserscope 是一个开源项目，用于测试Web浏览器的性能，如程序概要分析，存储和收集crowd-sourced数据等。
- DOM Monster
    - DOM Monster 由script.aculo.us的作者开发的一个用于分析Web页面的DOM和其它特性。它能够检查HTML+JavaScript代码，并一些警告和建议如：减少使用样式属性的标签数量；查找JavaScript全局变量，并减少它们以便改进性能等。
- Mobileperf Bookmarklet
    - Mobileperf Bookmarklet是针对于移动设备的Web调试器和分析器。
- Redbot
    - 这是一个机器人工具，帮助用户检查HTTP资源，可查看它的操作情况，指出常见的问题并提出改进。
- Boomerang
    - Boomerang是由雅虎Exceptional Performance(异常性能)小组发布的网站性能监测工具，能从最终用户的角度来衡量网站性能，并将数据发送回服务器以便进一步分析。
- Wappalyzer
    - Wappalyzer插件可以告诉你当前正在访问的网页是采用什么软件搭建的。它能够检测出CMS和电子商务系统、留言板、javascript框架，主机面板，分析统计工具和其它的一些web系统。
- Netalyzer
    - Netalyzer是一款用于搜集域名、跟踪路由器信息的小型工具。
- Shunra NetworkCatcher Express
    - Shunra NetworkCatcher是一款高度灵活的、功能强大的网络监控工具，使企业能够轻松准确地记录、导入、重播真实网络行为，如延迟，丢包和可用带宽。
- Fiddler
    - Fiddler是最强大最好用的Web调试工具之一，它能记录所有客户端和服务器的http和https请求，允许你监视，设置断点，甚至修改输入输出数据。
- Charles
    - Charles是一个HTTP代理服务器，TTP监视器，反转代理服务器。它允许一个开发者查看所有连接互联网的HTTP通信。这些包括request，response现HTTP headers （包含cookies与caching信息）。
- CSS Lint
    - CSSLint 是一个用来帮你找出 CSS 代码中问题的工具，它可做基本的语法检查以及使用一套预设的规则来检查代码中的问题，规则是可以扩展的。
- JSLint
    - JSLint是一个JavaScript验证工具(非开源),可以扫描JavaScript源代码来查找问题
- GTMetri
    - Gtmetrix是国外的一个免费评测网页载入速度的服务,挺专业的,提供了详细报告,而且会保存每一个网站的记录,可以方便查看一个网站载入速度的历史变化。

## 负载测试    
    
- KITE
    - KITE网络测试环境是由Keynote公司开发的一个基于云平台的网站性能和负载测试平台。

## 压测工具

- Siege
    - Siege是一个压力测试和评测工具,设计用于WEB开发这评估应用在压力下的承受能力。
- Tsung
    - Tsung 是一个压力测试工具,可以测试包括HTTP, WebDAV, PostgreSQL, MySQL, LDAP, and XMPP/Jabber等服务器。

## 自动生成文档

http://editor.swagger.io/#/
https://github.com/swagger-api/swagger-ui